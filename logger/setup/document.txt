実験に参加してくださりありがとうございます。
これは実験環境のセットアップマニュアルです

用意するもの
・logger.zip
・keyファイル(別途配布または同梱)
・ログインパスワード(sudoで必要です)
・インターネットに接続した設定するマシン

このドキュメントは基本的にNetwalkerを対象に書かれています。
他の環境では適時読み替えてください。

*ファイルの配置
  ホームフォルダにlogger.zipを解凍します。
  ~/logger ができましたか?
  以後の説明ではこのloggerディレクトリを基準に説明していきます。

  loggerディレクトリの直下に、別途配布した
    key  key.pub  を配置します。

  (このファイルは公開鍵暗号の秘密鍵にあたるもので、
  ログファイル送信ツールで使用しています。
  ログファイルの送信のみに権限が制限されていますが、
  なるべく流出させないよう扱ってください。
  いちおう研究室ごとに違う鍵を配布しています。)

  この段階で以下のようなディレクトリ構造になっていると思います。
  ~/logger
  ~/logger/key
  ~/logger/key.pub
  ~/logger/...(他のファイル)


*環境の設定
  logger下にあるsetupディレクトリには、環境の設定を行うシェルスクリプトや
  本ドキュメントなどが置かれています。
  
  ~/logger/setup/document.txt   この文章
  ~/logger/setup/all.sh         以下の3つのスクリプトを順に実行する
  ~/logger/setup/initialize.sh  基本設定
  ~/logger/setup/set_powermanager.sh 電源管理の設定
  ~/logger/setup/stop_services.sh    不要なサービスの停止
  ~/logger/setup/add_env_kscproxy.sh bashの環境変数にkscのproxyを追加
                      (環境によるためproxyの追加はallで実行されません)

  これから、これらのスクリプトを実行していきます。
  適時パスワードを要求されるので、
  GUI(アイコンをクリックで)から実行する場合は[端末内で実行する]で行ってください。
  
  ネットワークに接続する場合があるので、環境に応じたproxyを設定してください。
  環境変数 http_proxy が設定されていれば動くと思います。
  例として学内のproxyをコマンドラインから設定する場合は、
  $ export http_proxy=http://proxy.ksc.kwansei.ac.jp:8080/ を入力してください。
  bashの環境変数に上記のproxyを設定する場合は、  
  ~/logger/setup/add_env_kscproxy.sh を実行してください。

  初期設定状態のログ取り専用Netwalkerには簡単のため
  ~/logger/setup/内で、all.sh を実行してください。
  その中では以下の内容が呼ばれます。
  適時パスワードの入力や、確認のyをタイプしてください。

  異なる環境の場合や、
  自分の設定が変更されたくない方は以下を参考に設定を行ってください。

  ~/logger/setup/initialize.sh (ほぼ必須)
    依存するパッケージ(ssh rsync sysv-rc-conf ruby wget)のダウンロード
    bt&wifiデバイスの有向化、btデバイスの外部からの可視化
    毎時自動で時刻合わせを行う設定

    (必ず管理者権限が要求されます、ユーザアカウントのパスワードを入力してください
    "接続できませんでした" 等のエラーメッセージが出る場合は、
    proxyの設定を確認して再度行ってください。
    コマンドラインから、
    $ export http_proxy=http://proxy.ksc.kwansei.ac.jp:8080/
    $ cd ~/logger/setup/
    $ ./initialize.sh
    を実行すれば学内LANからは行けると思います。)

  
　~/logger/setup/set_powermanager.sh (省電源化、サスペンド抑止)
    自動でgnome-power-managerの設定を行います。
    問題なく動けば実行時の出力はありません。
     
    (画面の明るさの設定は、設定中に暗くなると困るため行っていません。
    実験時は、バッテリ延命のためモニタの明るさを最小にしてください。
    上部メニューバーの太陽のアイコンをタッチし
    -(マイナス)側へドラッグするか-を最小になるまで何度かタッチしてください。)
                                     
  
  ~/logger/setupstop_services.sh (不要なサービスの停止)
    使わないであろうサービスを停止します。
    ログ取り専用なら停止しても支障はありません。                             
    実行時の出力はパスワード要求以外ありません。
    連続して設定を行う場合は前回のパスワードが有効であれば入力は不要です。


  blutoothデバイス名の設定
　　記録されるログで用いるユーザ名、他人にBDAと共に検出される名前を設定します。
    
    GUIから設定される場合は、
    上部メニューバーの
    「システム」->「設定」->「Bluetoothマネージャー」->「アダプタ」->「設定」
    を開き、「簡易名」を適当な名前に設定してください。
    (「可視設定」が常に表示になってるかもついでに確認してください。)
    
    コマンドラインからは以下で設定ができます。
    $ sudo hciconfig hci0 name デバイス名

  以上で環境の初期設定は完了です。
  ここまでは問題がなければ最初に1度行えば構いません。


*ロガーの設定と使い方
  ~/logger以下にあるファイルについて説明します。
    ~/logger/logger.rb     ロガースクリプト
    ~/logger/config.yaml   ロガー設定ファイル
    ~/logger/send_log.rb   ログ送信スクリプト
    ~/logger/update.sh     ロガーアップデートツール
    ~/logger/key           環境設定で配置した非公開鍵
    ~/logger/key.pub       環境設定で配置した公開鍵
    ~/logger/loggerlog.txt ロガー自体のログ(実行時に生成されます)
    ~/logger/logdata/      BT&wifiログファイル出力先
    ~/logger/...           setupファイル等その他

 Netwalker以外の環境の方はconfig.yamlを編集する必要がある場合があります。
 config;.yaml内のhci0とeth0を環境に応じたデバイスに書き換えてください。
 BTデバイスは $ hciconfig とタイプすれば一覧が、
 wifiデバイスは $ ifconfig とタイプすれば一覧が出ますので、
 使用するデバイス名をconfig.yamlに設定してください。

 ロガーの起動には
  $ ./logger.rb または　$ ruby ./logger.rbとコマンドラインから起動するか、
  logger.rbをクリックして[端末内で実行]してください。
  ログファイルが~/logger/logdata/ 以下に出力されていきます。
  ロガーを停止するにはCtrl＋Cまたは端末を閉じていただいて構いません。

  ロガーの起動はマシンの起動時に行っていただく必要があります。
  スタートアップ時に自動でロガーを起動する場合は、
　[システム]->[設定]->[自動起動するアプリ]から[新規]を選び
  [コマンド]に gnome-terminal -e /home/(ユーザ名)/logger/logger.rb
  と入力し、ログアウト&ログインで動作を確認してください。
  (~/からのパスではだめなようです)

*ログ送信ツールの使い方
  ロガーと同様に $ ./send_log.rb や $　ruby ./send_log.rb などや
  send_log.rbをクリックして起動してください。
  初回の起動時のみ公開鍵の指紋確認がありますのでyesをタイプしてください。
  ~/logger/logdata/以下のログと、loggerlog.txtをサーバーに送信します。
  ログは差分のみを送信していますので、頻繁に実行して頂いてかまいません。
  起動時の自動実行についてはロガーの場合と同様に設定できますが、
  起動時のネットワーク接続とのラグにより失敗することが多いです。
  面倒ですがインターネットに接続した状態から手動で行う感じになります。

  $ nautilus /home/(ユーザ名)/logger/ を自動起動に設定すれば
  自動でロガーのディレクトリを開くことができるのでお役立てください。

*アップデートツールの使い方
 こちらからアップデートの連絡があった場合、インターネットに接続した状態で
 実行してください。wgetで最新版をダウンロードし、現在のロガーを上書きします。
 実行したディレクトリに展開するため
 実行の時はコマンドライン上から~/loggerディレクトリ内で行ってください。


設定は以上です。
繰り返しになりますが、
  実験時は、バッテリ延命のためモニタの明るさを最小にしてください。
  上部メニューバーの太陽のアイコンをタッチし
  -(マイナス)側へドラッグするか-を最小になるまで何度かタッチしてください。



動作の不明な点、改善点、エラー等のご意見や質問は、
河野研徳網(amo68053☆kwansei.ac.jp)へご連絡ください(☆→@)。
研究室へ直接来ていただいても構いません。
エラーの際は~/logger/loggerlog.txtも添付して頂けると解決に役立ちます。

面倒な実験に協力していただいてありがとうございます。
お手間をおかけしますがどうかよろしくお願いします。
